<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add USDT to Your Wallet</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <style>
        :root {
            --primary-color: #26a17b;
            --primary-dark: #1a8a6a;
            --text-color: #333;
            --text-secondary: #666;
            --background-color: #f8f9fa;
            --card-background: #fff;
            --border-color: #e9ecef;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --error-color: #dc3545;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--background-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            line-height: 1.6;
        }
        
        .container {
            max-width: 520px;
            margin: 0 auto;
            padding: 24px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        
        header {
            text-align: center;
            margin-bottom: 24px;
        }
        
        header h1 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--primary-color);
        }
        
        header p {
            color: var(--text-secondary);
            font-size: 16px;
        }
        
        .token-card {
            background: var(--card-background);
            border-radius: 16px;
            padding: 28px;
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.08);
            margin-bottom: 24px;
            flex-grow: 1;
            border: 1px solid var(--border-color);
        }
        
        .token-header {
            display: flex;
            align-items: center;
            margin-bottom: 24px;
            justify-content: space-between;
        }
        
        .token-logo-container {
            display: flex;
            align-items: center;
        }
        
        .token-logo {
            width: 54px;
            height: 54px;
            border-radius: 50%;
            margin-right: 18px;
            padding: 4px;
            border: 2px solid var(--primary-color);
            background-color: white;
        }
        
        .token-title h2 {
            margin: 0;
            font-size: 22px;
            font-weight: 600;
            color: var(--text-color);
        }
        
        .token-title p {
            margin: 4px 0 0;
            font-size: 15px;
            color: var(--text-secondary);
        }
        
        .network-badge {
            display: flex;
            align-items: center;
            padding: 6px 12px;
            background-color: #f9e9e9;
            color: #c12037;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
        }
        
        .network-badge img {
            height: 18px;
            margin-right: 6px;
        }
        
        .token-details {
            margin-bottom: 28px;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            overflow: hidden;
        }
        
        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 14px 16px;
            border-bottom: 1px solid var(--border-color);
            background-color: #fdfdfd;
        }
        
        .detail-row:last-child {
            border-bottom: none;
        }
        
        .detail-label {
            color: var(--text-secondary);
            font-size: 15px;
            font-weight: 500;
        }
        
        .detail-value {
            font-weight: 500;
            font-size: 15px;
            text-align: right;
            color: var(--text-color);
            word-break: break-all;
            max-width: 240px;
        }
        
        .contract-value {
            display: flex;
            align-items: center;
        }
        
        .copy-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--primary-color);
            margin-left: 8px;
            font-size: 14px;
        }
        
        .btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 16px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 16px;
        }
        
        .btn:hover {
            background-color: var(--primary-dark);
        }
        
        .btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background-color: #f8f9fa;
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }
        
        .btn-secondary:hover {
            background-color: #e9ecef;
        }
        
        .btn-icon {
            margin-right: 8px;
        }
        
        .status-container {
            margin-top: 20px;
        }
        
        .status-step {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
            padding: 10px;
            border-radius: 8px;
            background-color: #f8f9fa;
        }
        
        .status-step.active {
            background-color: #e6f7ff;
            border-left: 4px solid #1890ff;
        }
        
        .status-step.success {
            background-color: #f6ffed;
            border-left: 4px solid #52c41a;
        }
        
        .status-step.error {
            background-color: #fff2f0;
            border-left: 4px solid #ff4d4f;
        }
        
        .step-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background-color: #eee;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            flex-shrink: 0;
        }
        
        .step-icon.success {
            background-color: #52c41a;
            color: white;
        }
        
        .step-icon.error {
            background-color: #ff4d4f;
            color: white;
        }
        
        .step-icon.active {
            background-color: #1890ff;
            color: white;
        }
        
        .step-content {
            flex-grow: 1;
        }
        
        .step-title {
            font-weight: 500;
            margin-bottom: 2px;
        }
        
        .step-description {
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        .success-message {
            background-color: #f6ffed;
            border: 1px solid #b7eb8f;
            color: #52c41a;
            padding: 16px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            margin-bottom: 24px;
            display: none;
        }
        
        .success-icon {
            font-size: 24px;
            margin-right: 12px;
        }
        
        .error-message {
            background-color: #fff2f0;
            border: 1px solid #ffccc7;
            color: #ff4d4f;
            padding: 16px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            margin-bottom: 24px;
            display: none;
        }
        
        .error-icon {
            font-size: 24px;
            margin-right: 12px;
        }
        
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 8px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .steps-section {
            margin-top: 40px;
            border-top: 1px solid var(--border-color);
            padding-top: 24px;
        }
        
        .steps-heading {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--text-color);
        }
        
        .verification-section {
            margin-top: 30px;
            display: none;
        }
        
        .verification-box {
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            background-color: #f8f9fa;
        }
        
        .verification-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--text-color);
        }
        
        .verification-buttons {
            display: flex;
            gap: 12px;
        }
        
        .verification-btn {
            flex: 1;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background-color: white;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .verification-btn:hover {
            background-color: #f0f7f4;
            border-color: var(--primary-color);
        }
        
        .verification-btn.yes {
            border-color: #52c41a;
        }
        
        .verification-btn.no {
            border-color: #ff4d4f;
        }
        
        footer {
            text-align: center;
            margin-top: auto;
            padding: 24px 16px;
            color: var(--text-secondary);
            font-size: 14px;
            border-top: 1px solid var(--border-color);
        }
        
        .tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
            margin-left: 4px;
        }
        
        .tooltip-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background-color: #e9ecef;
            color: #666;
            font-size: 12px;
            font-weight: bold;
        }
        
        .tooltip-text {
            visibility: hidden;
            width: 220px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
            font-weight: normal;
        }
        
        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        
        .troubleshooting-section {
            margin-top: 40px;
            border-top: 1px solid var(--border-color);
            padding-top: 24px;
            display: none;
        }
        
        .troubleshooting-heading {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--text-color);
        }
        
        .troubleshooting-tips {
            margin-bottom: 20px;
        }
        
        .tip {
            margin-bottom: 12px;
            padding-left: 24px;
            position: relative;
        }
        
        .tip::before {
            content: "•";
            position: absolute;
            left: 8px;
            color: var(--primary-color);
            font-weight: bold;
        }
        
        /* Mobile optimization */
        @media (max-width: 576px) {
            .container {
                padding: 16px;
            }
            
            .token-card {
                padding: 20px;
            }
            
            .token-logo {
                width: 44px;
                height: 44px;
                margin-right: 14px;
            }
            
            .token-title h2 {
                font-size: 20px;
            }
            
            .detail-value {
                max-width: 190px;
                font-size: 14px;
            }
            
            .verification-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Add USDT to Your Wallet</h1>
            <p>Import Tether USD (USDT) with correct logo</p>
        </header>
        
        <div class="success-message" id="successMessage">
            <span class="success-icon">✓</span>
            <div>
                <strong>Success!</strong> USDT token has been added to your wallet.
            </div>
        </div>
        
        <div class="error-message" id="errorMessage">
            <span class="error-icon">⚠</span>
            <div id="errorText">
                <strong>Error!</strong> Failed to add token. Please try again.
            </div>
        </div>
        
        <div class="token-card" id="tokenCard">
            <div class="token-header">
                <div class="token-logo-container">
                    <img src="https://cryptologos.cc/logos/tether-usdt-logo.png" alt="USDT Logo" class="token-logo" id="tokenLogo">
                    <div class="token-title">
                        <h2>Tether USD</h2>
                        <p>Stablecoin pegged to USD</p>
                    </div>
                </div>
                <div class="network-badge">
                    <img src="https://cryptologos.cc/logos/bnb-bnb-logo.png" alt="BSC" id="networkLogo">
                    <span>BSC</span>
                </div>
            </div>
            
            <div class="token-details" id="tokenDetails">
                <div class="detail-row">
                    <div class="detail-label">Symbol</div>
                    <div class="detail-value">USDT</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Contract Address</div>
                    <div class="detail-value">
                        <div class="contract-value">
                            <span id="contractAddress">0x6ba2344F60C999D0ea102C59Ab8BE6872796C08c</span>
                            <button class="copy-btn" id="copyBtn">Copy</button>
                        </div>
                    </div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Decimals</div>
                    <div class="detail-value">6</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Network</div>
                    <div class="detail-value">Binance Smart Chain (BSC)</div>
                </div>
            </div>
            
            <button id="addTokenBtn" class="btn">
                <span class="btn-icon">+</span>
                Add USDT to Wallet with Logo
            </button>
            
            <button id="retryBtn" class="btn btn-secondary" style="display: none;">
                <span class="btn-icon">↻</span>
                Try Again with Different Method
            </button>
            
            <div class="status-container" id="statusContainer">
                <div class="status-step" id="step1">
                    <div class="step-icon" id="step1Icon">1</div>
                    <div class="step-content">
                        <div class="step-title">Connect wallet</div>
                        <div class="step-description">Connecting to your wallet...</div>
                    </div>
                </div>
                
                <div class="status-step" id="step2">
                    <div class="step-icon" id="step2Icon">2</div>
                    <div class="step-content">
                        <div class="step-title">Switch to BSC network</div>
                        <div class="step-description">Checking network...</div>
                    </div>
                </div>
                
                <div class="status-step" id="step3">
                    <div class="step-icon" id="step3Icon">3</div>
                    <div class="step-content">
                        <div class="step-title">Add USDT token</div>
                        <div class="step-description">Adding token with logo...</div>
                    </div>
                </div>
                
                <div class="status-step" id="step4">
                    <div class="step-icon" id="step4Icon">4</div>
                    <div class="step-content">
                        <div class="step-title">Verify token added</div>
                        <div class="step-description">Checking if token was added successfully...</div>
                    </div>
                </div>
            </div>
            
            <div class="verification-section" id="verificationSection">
                <div class="verification-box">
                    <div class="verification-title">Do you see the USDT logo in your wallet?</div>
                    <div class="verification-buttons">
                        <button class="verification-btn yes" id="verifyYesBtn">Yes, I can see the logo</button>
                        <button class="verification-btn no" id="verifyNoBtn">No, logo is missing</button>
                    </div>
                </div>
            </div>
            
            <div class="troubleshooting-section" id="troubleshootingSection">
                <div class="troubleshooting-heading">Troubleshooting Tips</div>
                <div class="troubleshooting-tips">
                    <div class="tip">Make sure you're using the latest version of MetaMask</div>
                    <div class="tip">Try clearing your MetaMask activity data: Settings → Advanced → Clear activity tab data</div>
                    <div class="tip">Refresh your browser and try again</div>
                    <div class="tip">Try using a different browser (Chrome works best)</div>
                    <div class="tip">If on mobile, try using the desktop version</div>
                </div>
                <button id="troubleshootRetryBtn" class="btn">
                    <span class="btn-icon">↻</span>
                    Try Again
                </button>
            </div>
        </div>
    </div>
    
    <footer>
        <p>© 2025 Blockchain Technology Lab</p>
    </footer>

    <script>
        // Token details
        const TOKEN_ADDRESS = '0x6ba2344F60C999D0ea102C59Ab8BE6872796C08c';
        const TOKEN_SYMBOL = 'USDT';
        const TOKEN_DECIMALS = 6;
        const TOKEN_NAME = 'Tether USD';
        const TOKEN_IMAGE = 'https://cryptologos.cc/logos/tether-usdt-logo.png';
        const BSC_CHAIN_ID = '0x38'; // 56 in hex
        
        // DOM elements
        const addTokenBtn = document.getElementById('addTokenBtn');
        const retryBtn = document.getElementById('retryBtn');
        const copyBtn = document.getElementById('copyBtn');
        const contractAddressEl = document.getElementById('contractAddress');
        const statusContainer = document.getElementById('statusContainer');
        const successMessage = document.getElementById('successMessage');
        const errorMessage = document.getElementById('errorMessage');
        const errorText = document.getElementById('errorText');
        const verificationSection = document.getElementById('verificationSection');
        const verifyYesBtn = document.getElementById('verifyYesBtn');
        const verifyNoBtn = document.getElementById('verifyNoBtn');
        const troubleshootingSection = document.getElementById('troubleshootingSection');
        const troubleshootRetryBtn = document.getElementById('troubleshootRetryBtn');
        const tokenLogo = document.getElementById('tokenLogo');
        const networkLogo = document.getElementById('networkLogo');
        
        // Step elements
        const step1 = document.getElementById('step1');
        const step2 = document.getElementById('step2');
        const step3 = document.getElementById('step3');
        const step4 = document.getElementById('step4');
        const step1Icon = document.getElementById('step1Icon');
        const step2Icon = document.getElementById('step2Icon');
        const step3Icon = document.getElementById('step3Icon');
        const step4Icon = document.getElementById('step4Icon');
        
        // Variables
        let provider;
        let signer;
        let account;
        let connected = false;
        let currentStep = 0;
        let retryCount = 0;
        
        // Initialize
        function init() {
            // Hide status steps initially
            statusContainer.style.display = 'none';
            
            // Check for image loading errors
            tokenLogo.onerror = function() {
                this.src = 'https://assets.coingecko.com/coins/images/325/small/Tether.png';
            };
            
            networkLogo.onerror = function() {
                this.src = 'https://assets.coingecko.com/coins/images/825/small/bnb-icon2_2x.png';
            };
            
            // Copy contract address
            copyBtn.addEventListener('click', function() {
                const textToCopy = contractAddressEl.textContent;
                navigator.clipboard.writeText(textToCopy).then(function() {
                    copyBtn.textContent = 'Copied!';
                    setTimeout(function() {
                        copyBtn.textContent = 'Copy';
                    }, 2000);
                });
            });
            
            // Add token button
            addTokenBtn.addEventListener('click', startTokenAddProcess);
            
            // Retry button
            retryBtn.addEventListener('click', function() {
                retryCount++;
                resetUI();
                startTokenAddProcess(true);
            });
            
            // Verification buttons
            verifyYesBtn.addEventListener('click', function() {
                showSuccess("Great! The token has been added successfully with the logo.");
                verificationSection.style.display = 'none';
            });
            
            verifyNoBtn.addEventListener('click', function() {
                verificationSection.style.display = 'none';
                troubleshootingSection.style.display = 'block';
            });
            
            // Troubleshooting retry button
            troubleshootRetryBtn.addEventListener('click', function() {
                troubleshootingSection.style.display = 'none';
                retryCount++;
                resetUI();
                startTokenAddProcess(true);
            });
            
            // Check if already connected
            if (typeof window.ethereum !== 'undefined' && window.ethereum.selectedAddress) {
                account = window.ethereum.selectedAddress;
                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                connected = true;
            }
            
            // Listen for account changes
            if (window.ethereum) {
                window.ethereum.on('accountsChanged', function (accounts) {
                    window.location.reload();
                });
                
                window.ethereum.on('chainChanged', function (chainId) {
                    window.location.reload();
                });
            }
        }
        
        // Reset UI
        function resetUI() {
            successMessage.style.display = 'none';
            errorMessage.style.display = 'none';
            statusContainer.style.display = 'block';
            addTokenBtn.style.display = 'none';
            retryBtn.style.display = 'none';
            verificationSection.style.display = 'none';
            troubleshootingSection.style.display = 'none';
            
            // Reset steps
            currentStep = 0;
            step1.className = 'status-step';
            step2.className = 'status-step';
            step3.className = 'status-step';
            step4.className = 'status-step';
            step1Icon.className = 'step-icon';
            step2Icon.className = 'step-icon';
            step3Icon.className = 'step-icon';
            step4Icon.className = 'step-icon';
            step1Icon.innerHTML = '1';
            step2Icon.innerHTML = '2';
            step3Icon.innerHTML = '3';
            step4Icon.innerHTML = '4';
        }
        
        // Show success message
        function showSuccess(message) {
            successMessage.innerHTML = `<span class="success-icon">✓</span><div><strong>Success!</strong> ${message}</div>`;
            successMessage.style.display = 'flex';
            errorMessage.style.display = 'none';
            addTokenBtn.style.display = 'none';
            retryBtn.style.display = 'none';
        }
        
        // Show error message
        function showError(message) {
            errorText.innerHTML = `<strong>Error!</strong> ${message}`;
            errorMessage.style.display = 'flex';
            successMessage.style.display = 'none';
            addTokenBtn.style.display = 'none';
            retryBtn.style.display = 'block';
        }
        
        // Update step status
        function updateStep(step, status, message) {
            const stepEl = document.getElementById(`step${step}`);
            const iconEl = document.getElementById(`step${step}Icon`);
            const descEl = stepEl.querySelector('.step-description');
            
            // Reset previous active step
            if (currentStep > 0 && currentStep !== step) {
                const prevStepEl = document.getElementById(`step${currentStep}`);
                if (prevStepEl.className === 'status-step active') {
                    prevStepEl.className = 'status-step';
                }
            }
            
            currentStep = step;
            
            if (status === 'active') {
                stepEl.className = 'status-step active';
                iconEl.className = 'step-icon active';
                iconEl.innerHTML = '<span class="loading-spinner" style="width: 12px; height: 12px; margin: 0;"></span>';
            } else if (status === 'success') {
                stepEl.className = 'status-step success';
                iconEl.className = 'step-icon success';
                iconEl.innerHTML = '✓';
            } else if (status === 'error') {
                stepEl.className = 'status-step error';
                iconEl.className = 'step-icon error';
                iconEl.innerHTML = '!';
            }
            
            if (message) {
                descEl.textContent = message;
            }
        }
        
        // Start token add process
        async function startTokenAddProcess(isRetry = false) {
            resetUI();
            
            try {
                // Step 1: Connect wallet
                updateStep(1, 'active', 'Connecting to your wallet...');
                
                // Check if provider exists
                if (typeof window.ethereum === 'undefined') {
                    updateStep(1, 'error', 'MetaMask not detected');
                    showError('MetaMask extension not detected. Please install MetaMask and try again.');
                    return;
                }
                
                // Connect to wallet
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                if (!accounts || accounts.length === 0) {
                    updateStep(1, 'error', 'Failed to connect wallet');
                    showError('Failed to connect to your wallet. Please try again.');
                    return;
                }
                
                account = accounts[0];
                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                connected = true;
                
                updateStep(1, 'success', 'Wallet connected successfully');
                
                // Step 2: Switch to BSC network
                updateStep(2, 'active', 'Checking and switching network...');
                
                // Check current network
                const network = await provider.getNetwork();
                if (network.chainId !== 56) {
                    try {
                        // Try to switch to BSC
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: BSC_CHAIN_ID }],
                        });
                        
                        // Verify network switch
                        const updatedNetwork = await provider.getNetwork();
                        if (updatedNetwork.chainId !== 56) {
                            updateStep(2, 'error', 'Failed to switch to BSC network');
                            showError('Failed to switch to Binance Smart Chain. Please switch manually and try again.');
                            return;
                        }
                    } catch (switchError) {
                        if (switchError.code === 4902) {
                            // BSC not added to wallet, suggest adding it
                            try {
                                await window.ethereum.request({
                                    method: 'wallet_addEthereumChain',
                                    params: [{
                                        chainId: BSC_CHAIN_ID,
                                        chainName: 'Binance Smart Chain',
                                        nativeCurrency: {
                                            name: 'BNB',
                                            symbol: 'BNB',
                                            decimals: 18
                                        },
                                        rpcUrls: ['https://bsc-dataseed.binance.org/'],
                                        blockExplorerUrls: ['https://bscscan.com/']
                                    }]
                                });
                                
                                // Verify network addition
                                const updatedNetwork = await provider.getNetwork();
                                if (updatedNetwork.chainId !== 56) {
                                    updateStep(2, 'error', 'Failed to add BSC network');
                                    showError('Failed to add Binance Smart Chain. Please add it manually and try again.');
                                    return;
                                }
                            } catch (addError) {
                                updateStep(2, 'error', 'Failed to add BSC network');
                                showError('Failed to add Binance Smart Chain. Please try again or add it manually.');
                                return;
                            }
                        } else {
                            updateStep(2, 'error', 'Failed to switch to BSC network');
                            showError('Failed to switch to Binance Smart Chain. Please try again.');
                            return;
                        }
                    }
                }
                
                updateStep(2, 'success', 'Connected to BSC network');
                
                // Step 3: Add token
                updateStep(3, 'active', 'Adding token with logo...');
                
                // Different methods based on retry count
                let wasAdded = false;
                
                if (isRetry && retryCount % 2 === 1) {
                    // Alternative method - add with delayed execution
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                    wasAdded = await window.ethereum.request({
                        method: 'wallet_watchAsset',
                        params: {
                            type: 'ERC20',
                            options: {
                                address: TOKEN_ADDRESS,
                                symbol: TOKEN_SYMBOL,
                                decimals: TOKEN_DECIMALS,
                                image: TOKEN_IMAGE
                            }
                        }
                    });
                } else {
                    // Standard method
                    wasAdded = await window.ethereum.request({
                        method: 'wallet_watchAsset',
                        params: {
                            type: 'ERC20',
                            options: {
                                address: TOKEN_ADDRESS,
                                symbol: TOKEN_SYMBOL,
                                decimals: TOKEN_DECIMALS,
                                image: TOKEN_IMAGE
                            }
                        }
                    });
                }
                
                if (!wasAdded) {
                    updateStep(3, 'error', 'Token addition was canceled');
                    showError('You canceled the token addition. Please try again.');
                    return;
                }
                
                updateStep(3, 'success', 'Token added to wallet');
                
                // Step 4: Verify
                updateStep(4, 'active', 'Verifying token was added...');
                
                // Add a delay for better UX
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                updateStep(4, 'success', 'Verification complete');
                
                // Show verification section
                verificationSection.style.display = 'block';
                
            } catch (error) {
                console.error('Error in token add process:', error);
                
                // Update current step with error
                if (currentStep > 0) {
                    updateStep(currentStep, 'error', error.message || 'An error occurred');
                }
                
                showError(error.message || 'Failed to add token. Please try again.');
            }
        }
        
        // Initialize on load
        window.addEventListener('load', init);
    </script>
</body>
</html>
