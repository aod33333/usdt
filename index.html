<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Content-Security-Policy"
          content="default-src 'self';
          style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdnjs.cloudflare.com;
          font-src 'self' https://fonts.gstatic.com https://cdnjs.cloudflare.com;
          img-src 'self' data: https://i.ibb.co https://cryptologos.cc https://assets.coingecko.com;
          script-src 'self' https://cdnjs.cloudflare.com 'unsafe-inline' 'unsafe-eval';">
 
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes"> 
    <title>Trust Wallet</title>
    
    <!-- Font Links -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="total.css">
</head>
<body>

      <!-- Status Bar -->
    <div class="status-bar">
        <div class="status-time">02:08</div>
        <div class="status-icons">
            <i class="fas fa-key"></i>
            <i class="fas fa-volume-mute"></i>
            <i class="fas fa-wifi"></i>
            <i class="fas fa-signal"></i>
            <span>44%</span>
            <i class="fas fa-battery-half"></i>
        </div>
    </div>
    
    <!-- App container -->
    <div class="app-container">
        <!-- Lock Screen -->
        <div id="lock-screen" class="screen">
            <div class="lock-header">
                <img src="https://i.ibb.co/xPTTcgd/Trust-Wallet-Core-Logo-Blue.png" alt="Trust Wallet" class="lock-logo">
                <div class="lock-subtitle">Secure and trusted multi-chain crypto wallet</div>
            </div>
            <div class="passcode-container">
                <h3>Password</h3>
                <div class="passcode-dots">
                    <div class="dot"></div>
                    <div class="dot"></div>
                    <div class="dot"></div>
                    <div class="dot"></div>
                    <div class="dot"></div>
                    <div class="dot"></div>
                </div>
                
                <div class="numpad">
                    <button class="numpad-key" data-key="1">1</button>
                    <button class="numpad-key" data-key="2">2</button>
                    <button class="numpad-key" data-key="3">3</button>
                    <button class="numpad-key" data-key="4">4</button>
                    <button class="numpad-key" data-key="5">5</button>
                    <button class="numpad-key" data-key="6">6</button>
                    <button class="numpad-key" data-key="7">7</button>
                    <button class="numpad-key" data-key="8">8</button>
                    <button class="numpad-key" data-key="9">9</button>
                    <button class="numpad-key biometric" data-key="bio"><i class="fas fa-fingerprint"></i></button>
                    <button class="numpad-key" data-key="0">0</button>
                    <button class="numpad-key backspace" data-key="back"><i class="fas fa-backspace"></i></button>
                </div>
                
                <button id="unlock-button" class="unlock-button">Unlock</button>
                
                <div class="reset-wallet-container">
                    <p>Can't login? You can erase your current wallet and set up a new one</p>
                    <button id="reset-wallet-button" class="reset-wallet-button">Reset wallet</button>
                </div>
            </div>
        </div>
        

          <!-- Main Wallet Screen -->
        <div id="wallet-screen" class="screen hidden">
            <!-- Main Header with title -->
            <div class="main-header">
                <button class="icon-button settings-button">
                    <i class="fas fa-cog"></i>
                </button>
                <h1 class="page-title">Home</h1>
                <button class="icon-button notifications-button">
                    <i class="fas fa-bell"></i>
                </button>
            </div>
            
            <!-- Investment Warning Banner -->
            <div id="investment-warning" class="investment-warning">
                <div class="investment-warning-content">
                    <i class="fas fa-exclamation-circle warning-icon"></i>
                    <div class="investment-warning-text">
                        <p>Don't invest unless you're prepared to lose all the money you invest. This is a high-risk investment and you are unlikely to be protected if something goes wrong. <a href="#" class="learn-more">Take 2 mins to learn more</a>.</p>
                    </div>
                    <button id="close-investment-warning" class="close-warning">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            
            <div class="search-container">
                <div class="search-bar">
                    <i class="fas fa-search"></i>
                    <input type="text" 
                        id="search-input" 
                        name="search"
                        aria-label="Search tokens"
                        placeholder="Search">
                </div>
            </div>
            
            <!-- Wallet Selector -->
            <div class="wallet-selector-container">
                <div class="wallet-selector">
                    <span class="wallet-name">Main Wallet 1</span>
                    <i class="fas fa-chevron-down"></i>
                </div>
                <div class="wallet-actions">
                    <button class="wallet-action-button">
                        <i class="fas fa-copy"></i>
                    </button>
                    <button class="wallet-action-button">
                        <i class="fas fa-qrcode"></i>
                    </button>
                    <button class="wallet-action-button">
                        <i class="fas fa-bell"></i>
                    </button>
                </div>
            </div>
            
            <!-- Balance Display -->
            <div class="balance-display">
                <div class="balance-amount" id="total-balance">$0.00</div>
                <button class="visibility-toggle">
                    <i class="fas fa-eye"></i>
                </button>
            </div>
            
            <!-- Quick Actions -->
            <div class="quick-actions">
                <button class="action-circle" id="send-button">
                    <i class="fas fa-arrow-up"></i>
                    <span>Send</span>
                </button>
                <button class="action-circle" id="receive-button">
                    <i class="fas fa-arrow-down"></i>
                    <span>Receive</span>
                </button>
                <button class="action-circle">
                    <i class="fas fa-credit-card"></i>
                    <span>Buy</span>
                </button>
                <button class="action-circle">
                    <i class="fas fa-university"></i>
                    <span>Sell</span>
                </button>
                <button class="action-circle">
                    <i class="fas fa-history"></i>
                    <span>History</span>
                </button>
            </div>
            
            <div class="wallet-body">
                <!-- Tab Navigation -->
                <div class="tabs">
                    <button class="tab-button active" data-tab="tokens">Crypto (%24H)</button>
                    <button class="tab-button" data-tab="nfts">NFTs</button>
                </div>
                
                <!-- Token List -->
                <div class="token-list" id="token-list">
                    <!-- Tokens will be inserted here by JS -->
                </div>
                
                <!-- Footer Info -->
                <div class="footer-info">
                    Past performance is not a reliable indicator of future results. Data source is from CoinMarketCap. <a href="#" class="disclaimer-link">Learn more about risks</a>.
                    <div class="manage-crypto">Manage Crypto</div>
                </div>
            </div>
            
            <!-- Bottom Navigation -->
            <div class="bottom-tabs">
                <div class="tab-item active">
                    <i class="fas fa-home"></i>
                    <span>Home</span>
                </div>
                <div class="tab-item">
                    <i class="fas fa-exchange-alt"></i>
                    <span>Swap</span>
                </div>
                <div class="tab-item">
                    <i class="fas fa-piggy-bank"></i>
                    <span>Earn</span>
                </div>
                <div class="tab-item">
                    <i class="fas fa-compass"></i>
                    <span>Discover</span>
                </div>
            </div>
        </div>
        
        <!-- Token Detail Screen - Simplified for combined1.js -->
        <div id="token-detail" class="screen hidden"></div>

        <!-- Token Selection Screen - Simplified for combined1.js -->
        <div id="send-token-select" class="screen hidden"></div>
        
        <div id="send-screen" class="screen hidden"></div>

        <div id="receive-screen" class="screen hidden"></div>

        <div id="history-screen" class="screen hidden"></div>
        
        <!-- Transaction Status Modal -->
        <div id="tx-status-modal" class="modal">
            <div class="modal-content">
                <div class="tx-status-container">
                    <div id="tx-pending" class="tx-status-view">
                        <div class="tx-status-icon pending">
                            <i class="fas fa-clock"></i>
                        </div>
                        <h3>Transaction Pending</h3>
                        <p>Your transaction has been submitted to the network.</p>
                        <div class="tx-details">
                            <div class="tx-detail-row">
                                <span class="tx-label">Transaction Hash:</span>
                                <span id="tx-hash" class="tx-value">0x8a65...</span>
                            </div>
                            <div class="tx-detail-row">
                                <span class="tx-label">Confirmations:</span>
                                <span id="confirm-count" class="tx-value">0</span>
                            </div>
                        </div>
                    </div>
                    
                    <div id="tx-success" class="tx-status-view hidden">
                        <div class="tx-status-icon success">
                            <i class="fas fa-check"></i>
                        </div>
                        <h3>Transaction Successful</h3>
                        <p>Your transaction has been confirmed.</p>
                        <div class="tx-details">
                            <div class="tx-detail-row">
                                <span class="tx-label">Amount:</span>
                                <span id="tx-amount" class="tx-value">0 USDT</span>
                            </div>
                            <div class="tx-detail-row">
                                <span class="tx-label">To:</span>
                                <span id="tx-to" class="tx-value">0x742d...</span>
                            </div>
                            <div class="tx-detail-row">
                                <span class="tx-label">Network Fee:</span>
                                <span id="tx-fee" class="tx-value">0.000105 BNB</span>
                            </div>
                        </div>
                        <button id="close-tx-success" class="tx-button primary">Done</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Blockchain Explorer Overlay -->
        <div id="explorer-overlay" class="explorer-overlay">
            <div class="explorer-header">
                <button id="close-explorer" class="explorer-back-button">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <div class="explorer-title">Blockchain Explorer</div>
                <button class="explorer-button">
                    <i class="fas fa-ellipsis-v"></i>
                </button>
            </div>
            <div class="explorer-body">
                <div class="explorer-search-container">
                    <div class="explorer-search">
                        <i class="fas fa-search"></i>
                        <label for="explorer-search-input" class="visually-hidden">Search blockchain</label>
                        <input type="text" id="explorer-search-input" placeholder="Search by Address / Txn Hash / Block / Token">
                    </div>
                </div>
                
                <div class="explorer-transaction">
                    <div class="explorer-section">
                        <div class="explorer-section-header">
                            <h3>Transaction Details</h3>
                            <span class="explorer-status success">Success</span>
                        </div>
                        
                        <div class="explorer-detail-rows">
                            <div class="explorer-detail-row">
                                <div class="explorer-detail-label">Transaction Hash:</div>
                                <div id="explorer-tx-hash" class="explorer-detail-value">0x8a65d7c4f5f43c3b39...</div>
                            </div>
                            <div class="explorer-detail-row">
                                <div class="explorer-detail-label">Status:</div>
                                <div class="explorer-detail-value"><span class="explorer-badge success">Success</span> <span class="explorer-confirmations">285 Block Confirmations</span></div>
                            </div>
                            <div class="explorer-detail-row">
                                <div class="explorer-detail-label">Timestamp:</div>
                                <div id="explorer-timestamp" class="explorer-detail-value">Mar-22-2025 02:44:15 PM +UTC</div>
                            </div>
                            <div class="explorer-detail-row">
                                <div class="explorer-detail-label">From:</div>
                                <div id="explorer-from" class="explorer-detail-value address">0x9B3a54D092f6B4b3d2eC676cd589f124E9921E71</div>
                            </div>
                            <div class="explorer-detail-row">
                                <div class="explorer-detail-label">To:</div>
                                <div id="explorer-to" class="explorer-detail-value address">0x742d35Cc6634C0532925a3b844Bc454e4438f44e</div>
                            </div>
                            <div class="explorer-detail-row">
                                <div class="explorer-detail-label">Value:</div>
                                <div id="explorer-value" class="explorer-detail-value">0 BNB</div>
                            </div>
                            <div class="explorer-detail-row">
                                <div class="explorer-detail-label">Transaction Fee:</div>
                                <div class="explorer-detail-value">0.000105 BNB ($0.05)</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="explorer-section">
                        <div class="explorer-section-header">
                            <h3>Token Transfer</h3>
                        </div>
                        
                        <div class="explorer-token-transfer">
                            <div class="explorer-token-icon">
                                <img src="https://cryptologos.cc/logos/tether-usdt-logo.png" alt="USDT">
                            </div>
                            <div class="explorer-token-details">
                                <div class="explorer-token-from-to">
                                    <span class="explorer-address-short">0x9B3a...21E71</span>
                                    <i class="fas fa-arrow-right"></i>
                                    <span class="explorer-address-short">0x742d...8f44e</span>
                                </div>
                                <div class="explorer-token-info">
                                    <span>For</span>
                                    <span id="explorer-token-amount" class="explorer-token-amount">100 USDT</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

          <!-- Biometric Authentication Overlay -->
        <div id="biometric-overlay" class="modal">
            <div class="biometric-content">
                <h3>Touch ID</h3>
                <p>Verify your identity</p>
                <div class="fingerprint-container">
                    <div id="fingerprint-icon" class="fingerprint-icon">
                        <i class="fas fa-fingerprint"></i>
                    </div>
                    <div id="fingerprint-scanning" class="fingerprint-scanning"></div>
                </div>
                <div id="biometric-status" class="biometric-status">Touch sensor</div>
                <button id="cancel-biometric" class="cancel-biometric">Cancel</button>
            </div>
        </div>
        
        <!-- Admin Panel -->
        <div id="admin-panel" class="modal">
            <div class="admin-content">
                <h2>Admin Panel</h2>
                <button id="close-admin" class="close-button"><i class="fas fa-times"></i></button>
                
                <div class="admin-form">
                    <div class="admin-form-group">
                        <label for="admin-wallet-select">Select Wallet to Modify</label>
                        <select id="admin-wallet-select">
                            <option value="main">Mnemonic 1</option>
                            <option value="secondary">Mnemonic 2</option>
                            <option value="business">Mnemonic 3</option>
                        </select>
                    </div>
                    
                    <div class="admin-form-group">
                        <label for="admin-token-select">Select Token to Modify</label>
                        <select id="admin-token-select">
                            <option value="usdt">Tether (USDT)</option>
                            <option value="btc">Bitcoin (BTC)</option>
                            <option value="eth">Ethereum (ETH)</option>
                            <option value="bnb">Binance Coin (BNB)</option>
                            <option value="trx">Tron (TRX)</option>
                        </select>
                    </div>
                    
                    <div class="admin-form-group">
                        <label for="fake-balance">Token Balance</label>
                        <input type="number" id="fake-balance" placeholder="Enter amount" value="100000">
                    </div>
                    
                    <div class="admin-form-group">
                        <label for="expiration-time">Expiration (hours)</label>
                        <input type="number" id="expiration-time" value="48" min="1" max="168">
                    </div>
                    
                    <div class="admin-form-group checkbox">
                        <input type="checkbox" id="generate-history" checked>
                        <label for="generate-history">Create Fake Transaction History</label>
                    </div>
                    
                    <div class="admin-form-group checkbox">
                        <input type="checkbox" id="modify-all-wallets">
                        <label for="modify-all-wallets">Apply to all wallets</label>
                    </div>
                    
                    <button id="apply-fake" class="admin-button primary">Activate Fake Balance</button>
                    <button id="reset-wallet" class="admin-button secondary">Reset to Original</button>
                    <div class="expiration-timer">
                        <span class="expiration-label">Auto Reset:</span>
                        <span class="expiration-time" id="expiration-countdown">Not Active</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Verification overlay -->
        <div id="verification-overlay" class="modal">
            <div class="verification-content">
                <h2>Secure Blockchain Verification</h2>
                <div class="verification-progress">
                    <div class="progress-bar">
                        <div id="progress-fill" class="progress-fill"></div>
                    </div>
                    <div class="verification-status" id="verification-status">Connecting to blockchain...</div>
                </div>
                
                <div id="verification-result" class="verification-result hidden">
                    <div class="verification-badge">
                        <i class="fas fa-shield-alt"></i>
                        <span>VERIFIED</span>
                    </div>
                    <div class="verification-details">
                        <div class="detail-row">
                            <span class="detail-label">Certificate ID:</span>
                            <span class="detail-value" id="cert-id">TW-A7B3C9D2</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Timestamp:</span>
                            <span class="detail-value" id="verify-timestamp">03/22/2025 02:44:13</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Wallet Address:</span>
                            <span class="detail-value">0x9B3a...9921E71</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">USDT Balance:</span>
                            <span class="detail-value" id="verify-balance">$100,000.00</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Status:</span>
                            <span class="detail-value positive">Valid</span>
                        </div>
                    </div>
                    
                    <div class="verification-actions">
                        <button id="close-verification" class="verification-button">Close</button>
                        <button id="view-blockchain" class="verification-button secondary">
                            <i class="fas fa-external-link-alt"></i> View on Blockchain
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div><!-- End of app-container -->

 <!-- Initialize global variables -->
<script>
    // Minimal global variables needed before loading combined1.js
    window.originalWalletData = null;
    window.currentWalletData = null;
    window.activeWallet = 'main';
    window.correctPasscode = '123456';
    window.passcodeEntered = '';

    // Setup demo balance function
    window.setupDemoBalance = function() {
      console.log('Demo balance setup called');
      
      // Get active wallet
      const activeWallet = window.activeWallet || 'main';
      
      // Simple balance update
      const totalBalance = document.getElementById('total-balance');
      if (totalBalance && window.currentWalletData && window.currentWalletData[activeWallet]) {
        totalBalance.textContent = '$' + window.currentWalletData[activeWallet].totalBalance.toFixed(2);
        return true;
      } else {
        console.error('Elements not available for demo balance');
        return false;
      }
    };
</script>

<!-- Replace the existing script block with this, just before loading combined1.js -->
<script>
  // Ensure critical global variables are set
  window.originalWalletData = null;
  window.currentWalletData = null;
  window.activeWallet = 'main';
  window.correctPasscode = '123456';
  window.passcodeEntered = '';

  // Setup demo balance with more robust fallbacks
  window.setupDemoBalance = function() {
    console.log('Demo balance setup called');
    
    try {
      const activeWallet = window.activeWallet || 'main';
      
      // Ensure wallet data exists
      if (!window.currentWalletData) {
        window.currentWalletData = {
          main: {
            totalBalance: 250000,
            tokens: [
              {
                id: 'btc',
                name: 'Bitcoin',
                symbol: 'BTC',
                amount: 1.5,
                value: 125976.11
              },
              {
                id: 'usdt',
                name: 'Tether',
                symbol: 'USDT',
                amount: 50000,
                value: 50000
              }
            ]
          }
        };
      }
      
      const totalBalance = document.getElementById('total-balance');
      if (totalBalance && window.currentWalletData[activeWallet]) {
        totalBalance.textContent = '$' + window.currentWalletData[activeWallet].totalBalance.toFixed(2);
        
        // Populate token list if function exists
        if (typeof window.populateMainWalletTokenList === 'function') {
          window.populateMainWalletTokenList();
        }
        
        return true;
      }
    } catch (error) {
      console.error('Demo balance setup failed:', error);
    }
    
    return false;
  };
</script>

 <script>
  // Global Initialization and Fallback Script
  (function() {
    // Ensure critical global variables exist
    window.originalWalletData = window.originalWalletData || null;
    window.currentWalletData = window.currentWalletData || null;
    window.activeWallet = window.activeWallet || 'main';
    window.correctPasscode = window.correctPasscode || '123456';
    window.passcodeEntered = window.passcodeEntered || '';

    // Comprehensive configuration with fallbacks
    window.CONFIG = window.CONFIG || {
      debug: false,
      initDelay: 500,
      screenLoadDelay: 300,
      finalCleanupDelay: 800,
      autoStartDemo: true,
      fixNetworkBadges: true,
      useAnimations: true,
      badgeRemovalInterval: 500,
      respectExistingEventHandlers: true
    };

    // Global fallback functions to prevent initialization errors
    window.navigateTo = window.navigateTo || function(targetScreenId, fromScreenId) {
      console.log(`Navigating to ${targetScreenId} from ${fromScreenId || 'unknown'}`);
      
      document.querySelectorAll('.screen').forEach(screen => {
        screen.style.display = 'none';
        screen.classList.add('hidden');
      });
      
      const targetScreen = document.getElementById(targetScreenId);
      if (targetScreen) {
        targetScreen.style.display = 'flex';
        targetScreen.classList.remove('hidden');
        
        if (fromScreenId) {
          targetScreen.dataset.returnTo = fromScreenId;
        }
        
        return true;
      }
      
      console.error(`Target screen ${targetScreenId} not found`);
      return false;
    };

    // Fallback demo balance setup
    window.setupDemoBalance = window.setupDemoBalance || function() {
      console.log('Setting up demo balance');
      
      if (!window.currentWalletData) {
        window.currentWalletData = {
          main: {
            totalBalance: 250000,
            tokens: [
              {
                id: 'btc',
                name: 'Bitcoin',
                symbol: 'BTC',
                amount: 1.5,
                value: 125976.11
              },
              {
                id: 'usdt',
                name: 'Tether',
                symbol: 'USDT',
                amount: 50000,
                value: 50000
              }
            ]
          }
        };
      }
      
      const totalBalance = document.getElementById('total-balance');
      if (totalBalance) {
        totalBalance.textContent = '$' + (window.currentWalletData.main.totalBalance || 250000).toFixed(2);
      }
      
      return true;
    };

    // Fallback functions for missing wallet methods
    const fallbackMethods = [
      'enhanceTransactions',
      'enhanceHomeScreen',
      'connectEventHandlers',
      'fixNetworkBadges',
      'fixTokenDetailView'
    ];

    fallbackMethods.forEach(method => {
      window[method] = window[method] || function() {
        console.log(`Default ${method} called - no specific enhancements`);
        return Promise.resolve();
      };
    });

    // Global error handling for initialization
    window.addEventListener('error', function(event) {
      console.error('Unhandled error during initialization:', event.error);
      // Optionally show user-friendly error message
      const errorDisplay = document.createElement('div');
      errorDisplay.textContent = 'An error occurred while loading the wallet. Please refresh the page.';
      errorDisplay.style.position = 'fixed';
      errorDisplay.style.top = '0';
      errorDisplay.style.left = '0';
      errorDisplay.style.width = '100%';
      errorDisplay.style.backgroundColor = 'red';
      errorDisplay.style.color = 'white';
      errorDisplay.style.padding = '10px';
      errorDisplay.style.textAlign = 'center';
      document.body.appendChild(errorDisplay);
    });

    // Optional: Log successful script injection
    console.log('🚀 Trust Wallet Global Initialization Script Loaded');
  })();
</script>

<!-- Load scripts with explicit order and defer -->
<script src="combined1.js" defer></script>
<script src="fix.js" defer></script>

<!-- Load combined1.js - this should be the only script besides our minimal initialization -->
<script src="combined1.js"></script>
<script src="fix.js"></script>
<!-- Comprehensive Fix Script -->
<script>
  (function() {
    console.log("🔧 Comprehensive fix script starting...");
    
    // Define critical missing functions
    window.fixBottomTabs = window.fixBottomTabs || function() {
      console.log("Fixing bottom tabs");
      const bottomTabs = document.querySelector('.bottom-tabs');
      if (!bottomTabs) {
        console.log('Bottom tabs not found, creating them');
        const newBottomTabs = document.createElement('div');
        newBottomTabs.className = 'bottom-tabs';
        newBottomTabs.innerHTML = `
          <div class="tab-item active">
            <i class="fas fa-home"></i>
            <span>Home</span>
          </div>
          <div class="tab-item">
            <i class="fas fa-chart-line"></i>
            <span>Trending</span>
          </div>
          <div class="tab-item">
            <i class="fas fa-exchange-alt"></i>
            <span>Swap</span>
          </div>
          <div class="tab-item">
            <i class="fas fa-piggy-bank"></i>
            <span>Earn</span>
          </div>
          <div class="tab-item">
            <i class="fas fa-compass"></i>
            <span>Discover</span>
          </div>
        `;
        document.body.appendChild(newBottomTabs);
      }
      return Promise.resolve();
    };
    
    // Define global navigation function if missing
    window.navigateTo = window.navigateTo || function(targetScreenId, fromScreenId) {
      console.log(`Navigating to ${targetScreenId} from ${fromScreenId || 'unknown'}`);
      
      // Hide all screens
      document.querySelectorAll('.screen').forEach(screen => {
        screen.style.display = 'none';
        screen.classList.add('hidden');
      });
      
      // Show target screen
      const targetScreen = document.getElementById(targetScreenId);
      if (targetScreen) {
        targetScreen.style.display = 'flex';
        targetScreen.classList.remove('hidden');
        
        // Set return to screen
        if (fromScreenId) {
          targetScreen.dataset.returnTo = fromScreenId;
        }
        
        // Apply fixes based on screen type
        setTimeout(() => {
          if (targetScreenId === 'token-detail') fixTokenDetailPage();
          if (targetScreenId === 'send-screen') fixSendScreen();
          if (targetScreenId === 'receive-screen') fixReceiveScreen();
          centerHeaderTitles();
        }, 50);
        
        return true;
      } else {
        console.error(`Target screen ${targetScreenId} not found`);
        return false;
      }
    };
    
    // Define missing fix functions
    window.fixTokenDetailPage = window.fixTokenDetailPage || function() {
      const tokenDetail = document.getElementById('token-detail');
      if (!tokenDetail) return;
      
      if (!tokenDetail.querySelector('.token-detail-content')) {
        tokenDetail.innerHTML = `
          <div class="detail-header">
            <button class="back-button">
              <i class="fas fa-arrow-left"></i>
            </button>
            <div class="token-detail-title">
              <h2 id="detail-symbol">BTC</h2>
              <span id="detail-fullname">Bitcoin</span>
            </div>
            <div class="header-icons">
              <button class="icon-button">
                <i class="fas fa-ellipsis-v"></i>
              </button>
            </div>
          </div>
          
          <div class="token-detail-content">
            <div class="token-detail-icon-container">
              <img src="https://cryptologos.cc/logos/bitcoin-btc-logo.png" alt="Token Logo" id="token-detail-icon" class="token-detail-large-icon">
            </div>
            
            <div class="token-detail-balance">
              <h2 id="token-balance-amount">0.00 BTC</h2>
              <p id="token-balance-value">$0.00</p>
            </div>
            
            <div class="token-detail-actions">
              <div class="detail-action">
                <i class="fas fa-arrow-up"></i>
                <span>Send</span>
              </div>
              <div class="detail-action">
                <i class="fas fa-arrow-down"></i>
                <span>Receive</span>
              </div>
              <div class="detail-action">
                <i class="fas fa-exchange-alt"></i>
                <span>Swap</span>
              </div>
              <div class="detail-action">
                <i class="fas fa-chart-line"></i>
                <span>Activity</span>
              </div>
            </div>
            
            <div class="transaction-header">
              <h3>Transactions</h3>
              <button class="filter-button">
                <i class="fas fa-filter"></i>
              </button>
            </div>
            
            <div id="transaction-list" class="transaction-list">
              <!-- Transactions will be dynamically populated -->
            </div>
            
            <div class="no-transactions" style="display: flex; flex-direction: column; align-items: center; padding: 40px 20px;">
              <div class="no-tx-icon">
                <i class="fas fa-inbox" style="font-size: 40px; color: #8A939D; opacity: 0.5;"></i>
              </div>
              <p style="margin-top: 16px; color: #5F6C75;">No transactions yet</p>
            </div>
            
            <div class="token-price-info">
              <div class="current-price">
                <h3 id="token-price-symbol">BTC Price</h3>
                <div class="price-with-change">
                  <span id="token-current-price">$0.00</span>
                  <span id="token-price-change" class="positive">+0.00%</span>
                </div>
                <span class="price-timeframe">Past 24 hours</span>
              </div>
              <div class="price-disclaimer">
                Past performance is not a reliable indicator of future results. Assets can go down as well as up.
              </div>
            </div>
          </div>
        `;
        
        // Connect back button
        const backButton = tokenDetail.querySelector('.back-button');
        if (backButton) {
          backButton.addEventListener('click', function() {
            window.navigateTo('wallet-screen');
          });
        }
      }
    };
    
    window.fixSendScreen = window.fixSendScreen || function() {
      const sendScreen = document.getElementById('send-screen');
      if (!sendScreen) return;
      
      if (!sendScreen.querySelector('.send-content')) {
        sendScreen.innerHTML = `
          <div class="screen-header">
            <button class="back-button" aria-label="Go back">
              <i class="fas fa-arrow-left"></i>
            </button>
            <h2 id="send-token-title">Send Token</h2>
          </div>
          <div class="send-content">
            <div class="form-group">
              <label for="recipient-address">Recipient Address</label>
              <div class="address-input">
                <input type="text" 
                  id="recipient-address" 
                  placeholder="Wallet Address or ENS">
                <button class="paste-button">Paste</button>
                <button class="scan-button">
                  <i class="fas fa-qrcode"></i>
                </button>
              </div>
            </div>
            <div class="form-group">
              <label for="send-amount">Amount</label>
              <div class="amount-input">
                <input type="text" 
                  id="send-amount" 
                  placeholder="0">
                <button class="max-button">Max</button>
              </div>
              <div id="available-balance">
                Available: <span id="max-amount">0</span> 
                <span id="max-symbol">USDT</span>
              </div>
            </div>
            <button id="continue-send" class="send-button">Continue</button>
          </div>
        `;
        
        // Connect back button
        const backButton = sendScreen.querySelector('.back-button');
        if (backButton) {
          backButton.addEventListener('click', function() {
            window.navigateTo('wallet-screen');
          });
        }
      }
    };
    
    window.fixReceiveScreen = window.fixReceiveScreen || function() {
      const receiveScreen = document.getElementById('receive-screen');
      if (!receiveScreen) return;
      
      if (!receiveScreen.querySelector('#receive-token-list')) {
        receiveScreen.innerHTML = `
          <div class="screen-header">
            <button class="back-button" aria-label="Go back">
              <i class="fas fa-arrow-left"></i>
            </button>
            <h2>Receive</h2>
          </div>
          <div class="search-container">
            <div class="search-bar token-search">
              <i class="fas fa-search"></i>
              <input type="text" id="receive-search-input" placeholder="Search" aria-label="Search tokens">
            </div>
          </div>
          <div class="networks-filter">
            <div class="all-networks">
              All Networks <i class="fas fa-chevron-down"></i>
            </div>
          </div>
          <div id="receive-token-list" class="token-list">
            <!-- Tokens will be dynamically populated here -->
          </div>
        `;
        
        // Connect back button
        const backButton = receiveScreen.querySelector('.back-button');
        if (backButton) {
          backButton.addEventListener('click', function() {
            window.navigateTo('wallet-screen');
          });
        }
      }
    };
    
    window.centerHeaderTitles = window.centerHeaderTitles || function() {
      document.querySelectorAll('.screen-header h2').forEach(title => {
        title.style.position = 'absolute';
        title.style.left = '0';
        title.style.right = '0';
        title.style.textAlign = 'center';
        title.style.width = 'auto';
        title.style.margin = '0 auto';
        title.style.zIndex = '1';
      });
    };
    
    window.showToast = window.showToast || function(message, duration = 2000) {
      // Remove any existing toast
      const existingToast = document.querySelector('.tw-toast');
      if (existingToast) {
        existingToast.remove();
      }
      
      // Create new toast
      const toast = document.createElement('div');
      toast.className = 'tw-toast';
      toast.textContent = message;
      document.body.appendChild(toast);
      
      // Show toast
      setTimeout(() => toast.classList.add('visible'), 10);
      
      // Hide and remove after duration
      setTimeout(() => {
        toast.classList.remove('visible');
        setTimeout(() => toast.remove(), 300);
      }, duration);
    };
    
    // Define wallet data if not already defined
    if (!window.currentWalletData || !window.currentWalletData.main || !window.currentWalletData.main.tokens) {
      window.currentWalletData = {
        main: {
          totalBalance: 250000,
          tokens: [
            {
              id: 'btc',
              name: 'Bitcoin',
              symbol: 'BTC',
              network: 'Bitcoin',
              icon: 'https://cryptologos.cc/logos/bitcoin-btc-logo.png',
              amount: 1.5,
              value: 125976.11,
              price: 83984.74,
              change: -0.59,
              chainBadge: null
            },
            {
              id: 'eth',
              name: 'Ethereum',
              symbol: 'ETH',
              network: 'Ethereum',
              icon: 'https://cryptologos.cc/logos/ethereum-eth-logo.png',
              amount: 10,
              value: 19738.10,
              price: 1973.81,
              change: -0.71,
              chainBadge: null
            },
            {
              id: 'usdt',
              name: 'Tether',
              symbol: 'USDT',
              network: 'BNB Smart Chain',
              icon: 'https://cryptologos.cc/logos/tether-usdt-logo.png',
              amount: 50000,
              value: 50000,
              price: 1.00,
              change: 0.00,
              chainBadge: 'https://cryptologos.cc/logos/bnb-bnb-logo.png'
            }
          ]
        }
      };
      
      // Backup for reset functionality
      window.originalWalletData = JSON.parse(JSON.stringify(window.currentWalletData));
    }
    
    // Fix for formatting utilities
    window.FormatUtils = window.FormatUtils || {
      formatCurrency: function(value) {
        if (isNaN(value)) return '$0.00';
        
        // Format based on size
        if (value >= 1000000) {
          return '$' + (value / 1000000).toFixed(2) + 'M';
        } else if (value >= 1000) {
          return '$' + (value / 1000).toFixed(2) + 'K';
        } else {
          return '$' + value.toFixed(2);
        }
      },
      formatTokenAmount: function(amount) {
        if (typeof amount !== 'number') {
          amount = parseFloat(amount) || 0;
        }
        
        // Format based on size
        if (amount >= 1000000) {
          return (amount / 1000000).toFixed(2) + 'M';
        } else if (amount >= 1000) {
          return (amount / 1000).toFixed(2) + 'K';
        } else if (amount >= 1) {
          return amount.toFixed(2);
        } else {
          return amount.toFixed(6);
        }
      }
    };
    
    // Get token logo URL helper function
    window.getTokenLogoUrl = window.getTokenLogoUrl || function(tokenId) {
      const logoUrls = {
        'btc': 'https://cryptologos.cc/logos/bitcoin-btc-logo.png',
        'eth': 'https://cryptologos.cc/logos/ethereum-eth-logo.png',
        'bnb': 'https://cryptologos.cc/logos/bnb-bnb-logo.png',
        'usdt': 'https://cryptologos.cc/logos/tether-usdt-logo.png',
        'twt': 'https://i.ibb.co/NdQ4xthx/Screenshot-2025-03-25-031716.png',
        'pol': 'https://cryptologos.cc/logos/polygon-matic-logo.png',
        'matic': 'https://cryptologos.cc/logos/polygon-matic-logo.png',
        'xrp': 'https://cryptologos.cc/logos/xrp-xrp-logo.png',
        'trx': 'https://cryptologos.cc/logos/tron-trx-logo.png',
        'sol': 'https://cryptologos.cc/logos/solana-sol-logo.png'
      };
      
      return logoUrls[tokenId] || 'https://cryptologos.cc/logos/bitcoin-btc-logo.png';
    };
    
    // Function to populate main wallet token list
    window.populateMainWalletTokenList = window.populateMainWalletTokenList || function() {
      const tokenList = document.getElementById('token-list');
      if (!tokenList) {
        console.error('Token list element not found');
        return;
      }
      
      // Clear list
      tokenList.innerHTML = '';
      
      // Get active wallet data
      const activeWallet = window.activeWallet || 'main';
      const wallet = window.currentWalletData && window.currentWalletData[activeWallet];
      
      if (!wallet || !wallet.tokens || !wallet.tokens.length) {
        console.error('No tokens available for main wallet display');
        return;
      }
      
      // Create token items
      wallet.tokens.forEach(token => {
        try {
          const tokenItem = document.createElement('div');
          tokenItem.className = 'token-item';
          tokenItem.setAttribute('data-token-id', token.id);
          
          // Format numbers for display
          const formattedAmount = token.amount.toLocaleString(undefined, {
            minimumFractionDigits: 2,
            maximumFractionDigits: 6
          });
          
          const formattedValue = window.FormatUtils && typeof window.FormatUtils.formatCurrency === 'function' ?
            window.FormatUtils.formatCurrency(token.value) : 
            '$' + token.value.toFixed(2);
          
          // Show network badge for specific tokens
          const showBadge = ['usdt', 'twt', 'bnb'].includes(token.id);
          const networkBadge = showBadge ? 
            `<div class="chain-badge"><img src="https://cryptologos.cc/logos/bnb-bnb-logo.png" alt="BNB Chain"></div>` : '';
          
          tokenItem.innerHTML = `
            <div class="token-icon">
              <img src="${window.getTokenLogoUrl ? window.getTokenLogoUrl(token.id) : token.icon}" alt="${token.name}">
              ${networkBadge}
            </div>
            <div class="token-info">
              <div class="token-name">${token.symbol}</div>
              <div class="token-price">
                ${token.name}
                <span class="token-price-change ${token.change >= 0 ? 'positive' : 'negative'}">
                  ${token.change >= 0 ? '+' : ''}${token.change}%
                </span>
              </div>
            </div>
            <div class="token-amount">
              <div class="token-balance">${formattedAmount} ${token.symbol}</div>
              <div class="token-value">${formattedValue}</div>
            </div>
          `;
          
          // Add click handler
          tokenItem.addEventListener('click', function() {
            if (typeof window.showTokenDetail === 'function') {
              window.showTokenDetail(token.id);
            } else {
              console.log('Token clicked:', token.id);
              window.navigateTo('token-detail');
            }
          });
          
          tokenList.appendChild(tokenItem);
        } catch (error) {
          console.error('Error creating token item:', error);
        }
      });
    };
    
    // Fix for showTokenDetail
    window.showTokenDetail = window.showTokenDetail || function(tokenId) {
      const tokenDetail = document.getElementById('token-detail');
      if (!tokenDetail) return;
      
      // Make sure token detail page has structure
      window.fixTokenDetailPage();
      
      // Update token details with actual token data
      const activeWallet = window.activeWallet || 'main';
      const wallet = window.currentWalletData && window.currentWalletData[activeWallet];
      
      if (!wallet || !wallet.tokens) return;
      
      const token = wallet.tokens.find(t => t.id === tokenId);
      if (!token) return;
      
      // Update content
      const detailSymbol = document.getElementById('detail-symbol');
      const detailFullname = document.getElementById('detail-fullname');
      const tokenDetailIcon = document.getElementById('token-detail-icon');
      const tokenBalanceAmount = document.getElementById('token-balance-amount');
      const tokenBalanceValue = document.getElementById('token-balance-value');
      const tokenPriceSymbol = document.getElementById('token-price-symbol');
      const tokenCurrentPrice = document.getElementById('token-current-price');
      const tokenPriceChange = document.getElementById('token-price-change');
      
      if (detailSymbol) detailSymbol.textContent = token.symbol;
      if (detailFullname) detailFullname.textContent = token.name;
      if (tokenDetailIcon) tokenDetailIcon.src = window.getTokenLogoUrl(token.id);
      if (tokenBalanceAmount) tokenBalanceAmount.textContent = token.amount.toFixed(6) + ' ' + token.symbol;
      if (tokenBalanceValue) tokenBalanceValue.textContent = window.FormatUtils.formatCurrency(token.value);
      if (tokenPriceSymbol) tokenPriceSymbol.textContent = token.symbol + ' Price';
      if (tokenCurrentPrice) tokenCurrentPrice.textContent = '$' + token.price.toLocaleString();
      
      if (tokenPriceChange) {
        tokenPriceChange.textContent = (token.change >= 0 ? '+' : '') + token.change + '%';
        tokenPriceChange.className = token.change >= 0 ? 'positive' : 'negative';
      }
      
      // Navigate to token detail
      window.navigateTo('token-detail', 'wallet-screen');
    };
    
    // Fix numpad functionality
    function setupNumpad() {
      // Clear previous listeners to avoid duplicates
      document.querySelectorAll('.numpad-key').forEach(key => {
        const newKey = key.cloneNode(true);
        key.parentNode.replaceChild(newKey, key);
        
        newKey.addEventListener('click', function() {
          const keyValue = this.getAttribute('data-key');
          
          if (keyValue === 'back') {
            // Backspace
            window.passcodeEntered = window.passcodeEntered.slice(0, -1);
          } else if (keyValue === 'bio') {
            // Biometric authentication
            const biometricOverlay = document.getElementById('biometric-overlay');
            if (biometricOverlay) {
              biometricOverlay.style.display = 'flex';
              
              // Simulate successful authentication after delay
              setTimeout(() => {
                biometricOverlay.style.display = 'none';
                window.navigateTo('wallet-screen');
              }, 2000);
            }
            return;
          } else {
            // Add digit
            window.passcodeEntered += keyValue;
            
            // Auto-unlock if correct passcode entered
            if (window.passcodeEntered.length === 6) {
              setTimeout(() => {
                // Check passcode
                if (window.passcodeEntered === window.correctPasscode) {
                  window.navigateTo('wallet-screen');
                  
                  // Populate token list
                  if (typeof window.populateMainWalletTokenList === 'function') {
                    window.populateMainWalletTokenList();
                  }
                } else {
                  // Shake animation for wrong passcode
                  const dotsContainer = document.querySelector('.passcode-dots');
                  if (dotsContainer) {
                    dotsContainer.classList.add('shake');
                    setTimeout(() => {
                      dotsContainer.classList.remove('shake');
                      window.passcodeEntered = '';
                      updateDots();
                    }, 500);
                  }
                }
              }, 300);
            }
          }
          
          // Update dots
          updateDots();
        });
      });
      
      // Also fix unlock button
      const unlockButton = document.getElementById('unlock-button');
      if (unlockButton) {
        unlockButton.onclick = function() {
          window.navigateTo('wallet-screen');
          if (typeof window.populateMainWalletTokenList === 'function') {
            window.populateMainWalletTokenList();
          }
        };
      }
    }
    
    // Update dots based on passcode
    function updateDots() {
      document.querySelectorAll('.dot').forEach((dot, index) => {
        dot.classList.toggle('filled', index < window.passcodeEntered.length);
      });
    }
    
    // Fix bottom navigation
    function fixBottomNavigation() {
      document.querySelectorAll('.tab-item').forEach(tab => {
        tab.addEventListener('click', function() {
          // Update active tab
          document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
          this.classList.add('active');
          
          // Show toast for non-home tabs
          const tabName = this.querySelector('span').textContent;
          if (tabName !== 'Home') {
            window.showToast(`${tabName} coming soon`);
          }
        });
      });
    }
    
    // Fix visibility toggle
    function fixVisibilityToggle() {
      const visibilityToggle = document.querySelector('.visibility-toggle');
      if (visibilityToggle) {
        visibilityToggle.addEventListener('click', function() {
          const icon = this.querySelector('i');
          const isVisible = icon.classList.contains('fa-eye');
          
          if (isVisible) {
            // Hide balance
            icon.classList.remove('fa-eye');
            icon.classList.add('fa-eye-slash');
            
            // Hide main balance
            const totalBalance = document.getElementById('total-balance');
            if (totalBalance) {
              window.cachedBalance = totalBalance.textContent;
              totalBalance.textContent = '••••••';
            }
            
            // Hide token balances
            document.querySelectorAll('.token-balance').forEach(el => {
              el.dataset.original = el.textContent;
              el.textContent = '••••••';
            });
            
            // Hide token values
            document.querySelectorAll('.token-value').forEach(el => {
              el.dataset.original = el.textContent;
              el.textContent = '••••••';
            });
          } else {
            // Show balance
            icon.classList.remove('fa-eye-slash');
            icon.classList.add('fa-eye');
            
            // Restore main balance
            const totalBalance = document.getElementById('total-balance');
            if (totalBalance && window.cachedBalance) {
              totalBalance.textContent = window.cachedBalance;
            }
            
            // Restore token balances
            document.querySelectorAll('.token-balance').forEach(el => {
              if (el.dataset.original) {
                el.textContent = el.dataset.original;
              }
            });
            
            // Restore token values
            document.querySelectorAll('.token-value').forEach(el => {
              if (el.dataset.original) {
                el.textContent = el.dataset.original;
              }
            });
          }
        });
      }
    }
    
    // Fix wallet selector
    function fixWalletSelector() {
      const walletSelector = document.querySelector('.wallet-selector');
      if (walletSelector) {
        walletSelector.addEventListener('click', function() {
          const walletName = this.querySelector('.wallet-name');
          if (!walletName) return;
          
          // Cycle through wallets
          const walletOrder = ['main', 'secondary', 'business'];
          const currentIndex = walletOrder.indexOf(window.activeWallet);
          const nextIndex = (currentIndex + 1) % walletOrder.length;
          window.activeWallet = walletOrder[nextIndex];
          
          // Update wallet name
          walletName.textContent = window.activeWallet === 'main' ? 'Main Wallet 1' : 
                                  window.activeWallet === 'secondary' ? 'Mnemonic 2' : 'Mnemonic 3';
          
          // Update UI
          if (typeof window.populateMainWalletTokenList === 'function') {
            window.populateMainWalletTokenList();
          }
          
          window.showToast('Switched to ' + walletName.textContent);
        });
      }
    }
    
    // Fix quick actions
    function fixQuickActions() {
      // Send button
      const sendButton = document.getElementById('send-button');
      if (sendButton) {
        sendButton.addEventListener('click', function() {
          window.navigateTo('send-screen');
        });
      }
      
      // Receive button
      const receiveButton = document.getElementById('receive-button');
      if (receiveButton) {
        receiveButton.addEventListener('click', function() {
          window.navigateTo('receive-screen');
        });
      }
      
      // Other action buttons
      document.querySelectorAll('.quick-actions .action-circle').forEach(button => {
        if (!button.id || (button.id !== 'send-button' && button.id !== 'receive-button')) {
          button.addEventListener('click', function() {
            const actionName = this.querySelector('span').textContent;
            window.showToast(`${actionName} functionality coming soon`);
          });
        }
      });
    }
    
    // Apply all fixes
    function applyAllFixes() {
      console.log("Applying all fixes");
      
      // Call critical fixes
      setupNumpad();
      fixBottomNavigation();
      fixVisibilityToggle();
      fixWalletSelector();
      fixQuickActions();
      centerHeaderTitles();
      
      // Populate the token list if needed
      if (document.getElementById('token-list') && 
          (!document.getElementById('token-list').children.length ||
           document.getElementById('token-list').children.length === 1)) {
        window.populateMainWalletTokenList();
      }
      
      console.log("🔧 All fixes applied successfully!");
    }
    
    // Run fixes after a short delay to ensure DOM is fully loaded
    setTimeout(applyAllFixes, 500);
    
    // Help users with a toast
    setTimeout(() => {
      window.showToast('Wallet interface has been fixed and optimized 👍');
    }, 1000);
  })();
</script>

</body>
</html>
